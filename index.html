<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ï¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; background-color: #FFF8E1; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border: 4px solid #004D40; }
        h1 { color: #004D40; font-size: 24px; }
        #quiz-area, #result-area, #ai-loading { display: none; }
        .question-box { font-size: 18px; font-weight: bold; margin-bottom: 20px; padding: 20px; background: #E8F5E9; border-radius: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-btn { background: #FFC107; border: none; border-radius: 50px; padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px #FF8F00; transition: 0.1s; }
        .option-btn:active { transform: translateY(2px); box-shadow: none; }
        
        /* AIç›¸è«‡ã‚¨ãƒªã‚¢ */
        .ai-section { background: #F3E5F5; border: 2px solid #9C27B0; border-radius: 15px; padding: 20px; margin-top: 25px; text-align: left; }
        .ai-title { color: #7B1FA2; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        textarea { width: 100%; height: 100px; border-radius: 10px; border: 1px solid #ccc; padding: 12px; box-sizing: border-box; margin-bottom: 12px; font-size: 14px; resize: none; }
        .ai-btn { background: #9C27B0; color: white; border: none; padding: 12px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
        #ai-response-box { display: none; background: white; border-radius: 10px; padding: 15px; margin-top: 15px; border-left: 5px solid #9C27B0; line-height: 1.7; font-size: 15px; }
        
        /* ãã®ä»– */
        .chart-container { position: relative; height: 300px; width: 100%; margin: 20px 0; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #9C27B0; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .restart-btn { margin-top: 20px; width: 100%; background: #9e9e9e; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>ğŸ’ AIãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ ğŸ’</h1>
        <p id="loading-message">è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        <button class="option-btn" id="start-button" onclick="startGame()" disabled style="width:100%">è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹ï¼</button>
    </div>

    <div id="quiz-area">
        <p style="font-size: 14px; color: #666;">ã—ã¤ã‚‚ã‚“ <span id="q-number">1</span> / <span id="q-total">0</span></p>
        <div class="question-box" id="question-text"></div>
        <div class="options" id="options-container"></div>
    </div>

    <div id="result-area">
        <h1>è¨ºæ–­çµæœï¼</h1>
        <div id="result-main"></div>
        <div class="chart-container"><canvas id="radarChart"></canvas></div>
        
        <div class="ai-section">
            <div class="ai-title">ğŸ”® AIå…ˆç”Ÿã®å€‹åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
            <p style="font-size: 13px; margin-bottom: 10px;">ãŠé‡‘ã«ã¤ã„ã¦å¤§åˆ‡ã«ã—ãŸã„ã“ã¨ã‚„ã€ä»Šã®æ°—æŒã¡ã‚’æ•™ãˆã¦ã­ã€‚AIå…ˆç”ŸãŒã‚­ãƒŸå°‚ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã‚Œã‚‹ã‚ˆï¼</p>
            <textarea id="ai-input" placeholder="ä¾‹ï¼šå°†æ¥ã®ãŸã‚ã«è²¯é‡‘ã‚’é ‘å¼µã‚ŠãŸã„ã§ã™ï¼ã§ã‚‚ã€ãŸã¾ã«ã¯å‹é”ã¨ãŠè“å­ã‚‚è²·ã„ãŸã„ãªã€‚"></textarea>
            <button class="ai-btn" id="ai-send-btn" onclick="sendToAI()">AIå…ˆç”Ÿã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</button>
            
            <div id="ai-loading">
                <div class="loading-spinner"></div>
                <p style="text-align:center; font-size: 12px;">AIå…ˆç”ŸãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ã„ã¾ã™...</p>
            </div>
            <div id="ai-response-box"></div>
        </div>

        <button class="restart-btn" onclick="location.reload()">ã‚‚ã†ä¸€å›è¨ºæ–­ã™ã‚‹</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ã“ã“ã‚’æ–°ã—ã„URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
    const GOOGLE_APP_URL = "https://script.google.com/macros/s/AKfycbw803TXjtzC5iQgVpUj5Ne1AiSyuSwiTYHq9sg7tcBEIl7XXuU_0lwl-KDd1ljYBg6MMg/exec"; 
    const QUESTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vST8GoXZbkMSYqF8usN6iKftOaDgx86x6hHdDrwqwYoyFa2YO9dz7MlyNZkX18prmzJK3Q8thEXa2ju/pub?gid=2097705279&single=true&output=csv"; 
    const RESULTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vST8GoXZbkMSYqF8usN6iKftOaDgx86x6hHdDrwqwYoyFa2YO9dz7MlyNZkX18prmzJK3Q8thEXa2ju/pub?gid=286038545&single=true&output=csv";

    let questions = [];
    let results = {};
    let currentQuestionIndex = 0;
    let scores = { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0, H: 0, N: 0 };
    let finalType = "";

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    window.onload = async () => {
        try {
            const [qRes, rRes] = await Promise.all([fetch(QUESTIONS_CSV_URL), fetch(RESULTS_CSV_URL)]);
            if(!qRes.ok || !rRes.ok) throw new Error("CSVèª­ã¿è¾¼ã¿å¤±æ•—");
            
            questions = parseCSV(await qRes.text());
            results = parseResultsCSV(await rRes.text());
            
            document.getElementById('q-total').innerText = questions.length;
            document.getElementById('loading-message').innerText = "æº–å‚™ãŒã§ããŸã‚ˆï¼";
            document.getElementById('start-button').disabled = false;
        } catch (e) {
            document.getElementById('loading-message').innerText = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            console.error(e);
        }
    };

    function parseCSV(text) {
        const rows = text.split('\n').filter(r => r.trim());
        const header = rows[0].split(',').map(h => h.trim());
        return rows.slice(1).map(row => {
            const cells = row.split(',').map(c => c.trim());
            const q = { text: cells[header.indexOf('text')], options: [] };
            header.filter(h => h.startsWith('opt')).forEach(h => {
                const cell = cells[header.indexOf(h)];
                if (cell) {
                    const match = cell.match(/(.*)\((.)\)/);
                    if (match) q.options.push({ text: match[1], type: match[2] });
                }
            });
            q.options.push({ text: "ã©ã‚Œã‚‚ã‚ã¦ã¯ã¾ã‚‰ãªã„", type: "N" });
            return q;
        });
    }

    function parseResultsCSV(text) {
        const rows = text.split('\n').filter(r => r.trim());
        const header = rows[0].split(',').map(h => h.trim());
        const res = {};
        rows.slice(1).forEach(row => {
            const cells = row.split(',').map(c => c.trim());
            const type = cells[header.indexOf('type')];
            res[type] = { animal: cells[header.indexOf('animal')], title: cells[header.indexOf('title')], desc: cells[header.indexOf('desc')] };
        });
        return res;
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';
        showQuestion();
    }

    function showQuestion() {
        const q = questions[currentQuestionIndex];
        document.getElementById('q-number').innerText = currentQuestionIndex + 1;
        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.text;
            btn.onclick = () => {
                scores[opt.type]++;
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) showQuestion();
                else showResult();
            };
            container.appendChild(btn);
        });
    }

    function showResult() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        const pScores = { A: scores.A, B: scores.B, C: scores.C, D: scores.D, E: scores.E, F: scores.F, G: scores.G, H: scores.H };
        let maxScore = -1;
        for (let t in pScores) { if (pScores[t] > maxScore) { maxScore = pScores[t]; finalType = t; } }
        if (scores.N > maxScore) finalType = "N";

        const res = results[finalType] || {animal:"â“", title:"ãªãã®ã‚¿ã‚¤ãƒ—", desc:"ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"};
        document.getElementById('result-main').innerHTML = `
            <div style="font-size:60px; margin-bottom:10px;">${res.animal}</div>
            <h2 style="color:#004D40; margin:0;">${res.title}</h2>
            <p style="text-align:left; font-size:14px; background:#f9f9f9; padding:15px; border-radius:10px; margin-top:15px;">${res.desc}</p>
        `;
        drawChart();
    }

    async function sendToAI() {
        const comment = document.getElementById('ai-input').value;
        if (!comment) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ã­ï¼");

        document.getElementById('ai-send-btn').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'block';

        try {
            const response = await fetch(GOOGLE_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    type: finalType,
                    comment: comment,
                    protect: scores.A + scores.G + scores.C,
                    use: scores.B + scores.F,
                    increase: scores.E + scores.H,
                    share: scores.D * 2
                })
            });

            const aiMsg = await response.text();
            document.getElementById('ai-loading').style.display = 'none';
            const resBox = document.getElementById('ai-response-box');
            resBox.style.display = 'block';
            resBox.innerText = aiMsg;
        } catch (e) {
            alert("AIå…ˆç”Ÿã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆå…¨å“¡ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            document.getElementById('ai-send-btn').style.display = 'block';
            document.getElementById('ai-loading').style.display = 'none';
        }
    }

    function drawChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['è²¯ã‚ã‚‹', 'ä½¿ã†', 'å¢—ã‚„ã™', 'åˆ†ã‘ã‚‹'],
                datasets: [{
                    label: 'ã‚­ãƒŸã®ãƒãƒãƒ¼ãƒãƒ©ãƒ³ã‚¹',
                    data: [scores.A+scores.G+scores.C, scores.B+scores.F, scores.E+scores.H, scores.D*2],
                    backgroundColor: 'rgba(255, 193, 7, 0.4)', borderColor: '#FFC107', borderWidth: 3, pointBackgroundColor: '#004D40'
                }]
            },
            options: { scales: { r: { beginAtZero: true, suggestedMax: 6, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }
</script>
</body>
</html>
